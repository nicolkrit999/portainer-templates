services:
    ghost-db:
        image: mysql:8
        container_name: ghost-db
        restart: always
        environment:
            - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
            - MYSQL_DATABASE=${MYSQL_DATABASE}
            - MYSQL_USER=${MYSQL_USER}
            - MYSQL_PASSWORD=${MYSQL_PASSWORD}
            - TZ=${TZ}
        volumes:
            - "/volume1/Default-volume-1/0001_Docker/ghost/mysql:/var/lib/mysql"
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p${MYSQL_ROOT_PASSWORD}"]
            interval: 20s
            timeout: 5s
            retries: 5
            start_period: 30s
        networks:
            - cloudflare-web

    ghost:
        image: ghost:6-alpine
        container_name: ghost
        restart: always
        depends_on:
            ghost-db:
                condition: service_healthy
        environment:
            - url=${GHOST_URL}
            - database__client=mysql
            - database__connection__host=ghost-db
            - database__connection__user=${MYSQL_USER}
            - database__connection__password=${MYSQL_PASSWORD}
            - database__connection__database=${MYSQL_DATABASE}
            - mail__transport=SMTP
            - mail__options__service=SMTP
            - mail__from=${MAIL_FROM}
            - mail__options__host=${SMTP_HOST}
            - mail__options__port=${SMTP_PORT}
            - mail__options__secure=${SMTP_SECURE}
            - mail__options__auth__user=${SMTP_USER}
            - mail__options__auth__pass=${SMTP_PASS}
            - NODE_ENV=production
            - TZ=${TZ}
        volumes:
            - "/volume1/Default-volume-1/0001_Docker/ghost/content:/var/lib/ghost/content"
        networks:
            - cloudflare-web

networks:
    cloudflare-web:
        external: true
